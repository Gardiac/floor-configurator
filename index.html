<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Floor Configurator â€” v4 (compact)</title>
<style>
  :root{--line:#e8e2da;--ink:#2b241e;--mut:#7b6a5a;--bg:#f7f4ef;--card:#fffdf9;--accent:#c07a3a}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto}
  header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:5}
  main{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:0 10px 22px rgba(0,0,0,.05)}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .row>*{flex:1}
  label{font-size:12px;color:var(--mut)}
  input[type=file],input[type=url],input[type=text]{padding:9px 10px;border:1px solid var(--line);border-radius:10px}
  .btn{padding:9px 10px;border:1px solid #d8c9b9;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#e7a563,#d68a48);color:#fff;border-color:#c77c3a}
  #wrap{position:relative;height:calc(100vh - 160px);min-height:360px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  .h{position:absolute;width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 1px 6px rgba(0,0,0,.25);transform:translate(-50%,-50%);cursor:grab}
  #msg{position:fixed;right:12px;bottom:12px;padding:8px 10px;border:1px solid var(--line);background:#fff;border-radius:10px;display:none}
  #debug{position:fixed;left:12px;bottom:12px;padding:8px 10px;border:1px solid var(--line);background:#fff;border-radius:10px;white-space:pre;max-width:50ch;display:none}
</style>
</head>
<body>
<header><b>ðŸªµ AI Floor Configurator â€” v4</b><span id="mode">(2D)</span></header>
<main>
  <section class="panel">
    <h3>Assets</h3>
    <div class="row"><label>Room photo</label><input id="roomFile" type="file" accept="image/*"></div>
    <div class="row"><label>Plank texture</label><input id="texFile" type="file" accept="image/*"></div>
    <div class="row"><label>Plank from URL</label><input id="texUrl" type="url" placeholder="https://â€¦/plank.jpg"><button id="loadUrl" class="btn">Load</button></div>
    <h3>AI & Detection</h3>
    <div class="row"><input id="prompt" type="text" placeholder="Replace the floor using the texture"></div>
    <div class="row"><button id="ai" class="btn primary">Detect & Replace (AI)</button><button id="auto" class="btn">Autoâ€‘detect (basic)</button></div>
    <h3>Layout</h3>
    <div class="row"><label>Scale <span id="sv">1.0</span></label><input id="scale" type="range" min="0.2" max="4" step="0.05" value="1"></div>
    <div class="row"><label>Rotation <span id="rv">0Â°</span></label><input id="rot" type="range" min="-90" max="90" step="0.5" value="0"></div>
    <h3>Export</h3>
    <div class="row"><button id="save" class="btn">Download PNG</button></div>
  </section>
  <section class="panel">
    <div id="wrap">
      <canvas id="room"></canvas>
      <canvas id="out"></canvas>
      <div class="h" id="h0" style="left:20%;top:70%"></div>
      <div class="h" id="h1" style="left:80%;top:70%"></div>
      <div class="h" id="h2" style="left:78%;top:94%"></div>
      <div class="h" id="h3" style="left:22%;top:94%"></div>
    </div>
  </section>
</main>
<div id="msg"></div><div id="debug"></div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const room=$('room'), out=$('out'), rctx=room.getContext('2d'), octx=out.getContext('2d');
  const state={roomImg:null, texImg:null, pattern:null, quad:[{x:.2,y:.7},{x:.8,y:.7},{x:.78,y:.94},{x:.22,y:.94}], roomRect:{x:0,y:0,w:0,h:0}, scale:1, rot:0};
  const msg=$('msg'), dbg=$('debug');
  function tip(t){ msg.textContent=t; msg.style.display='block'; setTimeout(()=>msg.style.display='none',2500); }
  function log(t){ dbg.textContent=t||''; dbg.style.display=t?'block':'none'; }

  function resize(){ const r=$('wrap').getBoundingClientRect(); room.width=r.width; room.height=r.height; out.width=r.width; out.height=r.height; drawRoom(); render(); }
  window.addEventListener('resize', resize);

  function readImage(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>rej('decode'); img.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(file); }); }
  function loadURL(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }

  $('roomFile').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return; state.roomImg=await readImage(f); drawRoom(); render(); tip('Room loaded');
  });
  $('texFile').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return; state.texImg=await readImage(f); buildPattern(); render(); tip('Texture loaded');
  });
  $('loadUrl').addEventListener('click', async ()=>{
    const u=$('texUrl').value.trim(); if(!u) return tip('Enter a URL'); try{ state.texImg=await loadURL(u); buildPattern(); render(); }catch(e){ tip('Failed to load URL (CORS?)'); }
  });

  $('scale').addEventListener('input', e=>{ state.scale=+e.target.value; $('sv').textContent=state.scale.toFixed(1); render(); });
  $('rot').addEventListener('input', e=>{ state.rot=+e.target.value; $('rv').textContent=state.rot.toFixed(1)+'Â°'; render(); });

  $('auto').addEventListener('click', ()=>{ const h=coarse(); if(h){ state.quad=h; syncHandles(); render(); tip('Auto-detect done'); }});
  $('ai').addEventListener('click', aiRun);
  $('save').addEventListener('click', ()=>{ const c=document.createElement('canvas'); c.width=out.width; c.height=out.height; const cx=c.getContext('2d'); cx.drawImage(room,0,0); cx.drawImage(out,0,0); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='floor.png'; a.click(); });

  const hs=[0,1,2,3].map(i=>$('h'+i));
  function syncHandles(){ for(let i=0;i<4;i++){ hs[i].style.left=(state.quad[i].x*100)+'%'; hs[i].style.top=(state.quad[i].y*100)+'%'; } }
  hs.forEach((el,i)=>{ let drag=false; el.addEventListener('pointerdown',e=>{drag=true; el.setPointerCapture(e.pointerId);});
    el.addEventListener('pointerup',e=>{drag=false; el.releasePointerCapture(e.pointerId);});
    el.addEventListener('pointermove',e=>{ if(!drag) return; const r=out.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width, y=(e.clientY-r.top)/r.height; state.quad[i]={x:clamp01(x),y:clamp01(y)}; render(); syncHandles(); });
  });

  function drawRoom(){
    const w=room.width,h=room.height; rctx.clearRect(0,0,w,h);
    if(!state.roomImg) return;
    const iw=state.roomImg.width, ih=state.roomImg.height;
    const s=Math.max(w/iw,h/ih), dw=iw*s, dh=ih*s, dx=(w-dw)/2, dy=(h-dh)/2;
    state.roomRect={x:dx,y:dy,w:dw,h:dh};
    rctx.drawImage(state.roomImg,dx,dy,dw,dh);
  }

  function buildPattern(){ if(!state.texImg) return; const c=document.createElement('canvas'); c.width=512; c.height=512; const cx=c.getContext('2d'); cx.drawImage(state.texImg,0,0,512,512); state.pattern=cx.createPattern(c,'repeat'); }

  function render(){ const w=out.width,h=out.height; octx.clearRect(0,0,w,h); if(!state.pattern) return;
    octx.save(); octx.beginPath(); octx.moveTo(state.quad[0].x*w,state.quad[0].y*h); for(let i=1;i<4;i++) octx.lineTo(state.quad[i].x*w,state.quad[i].y*h); octx.closePath(); octx.clip();
    const cx=(state.quad[0].x*w+state.quad[2].x*w)/2, cy=(state.quad[0].y*h+state.quad[2].y*h)/2;
    octx.translate(cx,cy); octx.rotate(state.rot*Math.PI/180); octx.scale(state.scale,state.scale); octx.translate(-cx,-cy);
    octx.fillStyle=state.pattern; octx.fillRect(0,0,w,h); octx.restore();
  }

  function coarse(){ if(!state.roomImg) return null; const W=room.width,H=room.height, c=document.createElement('canvas'); c.width=360; c.height=Math.round(360*H/W); const cx=c.getContext('2d');
    const s=Math.max(c.width/state.roomRect.w, c.height/state.roomRect.h), dw=state.roomRect.w*s, dh=state.roomRect.h*s, dx=(c.width-dw)/2 - state.roomRect.x*s, dy=(c.height-dh)/2 - state.roomRect.y*s;
    cx.drawImage(room,0,0,room.width,room.height, dx,dy,dw,dh);
    const img=cx.getImageData(0,0,c.width,c.height), d=img.data; const row=new Float32Array(c.height);
    for(let y=1;y<c.height-1;y++){ let sum=0; for(let x=1;x<c.width-1;x++){ const i=(y*c.width+x)*4; const g=d[i]*.299+d[i+1]*.587+d[i+2]*.114; const g1=d[i-4]*.299+d[i-3]*.587+d[i-2]*.114; sum+=Math.abs(g-g1);} row[y]=sum/c.width; }
    let yTop=0,best=-1; for(let y=Math.floor(c.height*.35);y<Math.floor(c.height*.9);y++){ if(row[y]>best){best=row[y]; yTop=y;} }
    const yN=yTop/c.height; return [{x:.18,y:yN},{x:.82,y:yN},{x:.92,y:.96},{x:.08,y:.96}];
  }

  function clamp01(x){ return Math.max(0,Math.min(1,x)); }
  function isBad(q){ if(!q||q.length!=4) return true; const ys=q.map(p=>p.y), minY=Math.min(...ys), maxY=Math.max(...ys); if(minY<0.1||maxY>1.02) return true; const A=polyArea(q,out.width,out.height), area=out.width*out.height; return A<0.05*area; }
  function polyArea(q,w,h){ const p=q.map(pt=>({x:pt.x*w,y:pt.y*h})); let a=0; for(let i=0;i<4;i++){ const j=(i+1)%4; a+=p[i].x*p[j].y-p[j].x*p[i].y; } return Math.abs(a)/2; }
  function sortCW(q){ const t=[...q].sort((a,b)=>a.y-b.y||a.x-b.x); const top=t.slice(0,2).sort((a,b)=>a.x-b.x); const bot=t.slice(2).sort((a,b)=>a.x-b.x); return [top[0],top[1],bot[1],bot[0]]; }
  function imgToCanvas(p){ const rr=state.roomRect, W=out.width,H=out.height; return {x:clamp01((rr.x+p.x*rr.w)/W), y:clamp01((rr.y+p.y*rr.h)/H)}; }
  function normalize(q){ const xs=q.map(p=>+p.x), ys=q.map(p=>+p.y); const maxX=Math.max(...xs), maxY=Math.max(...ys);
    if(maxX<=1.5 && maxY<=1.5) return q.map(p=>({x:clamp01(+p.x), y:clamp01(+p.y)}));
    if(maxX<=100.5 && maxY<=100.5) return q.map(p=>({x:clamp01(+p.x/100), y:clamp01(+p.y/100)}));
    const W=out.width,H=out.height; return q.map(p=>({x:clamp01(+p.x/W), y:clamp01(+p.y/H)}));
  }
  function iou(a,b){ function bb(q){const xs=q.map(p=>p.x), ys=q.map(p=>p.y); return {minx:Math.min(...xs),maxx:Math.max(...xs),miny:Math.min(...ys),maxy:Math.max(...ys)}}
    const A=bb(a), B=bb(b); const ix=Math.max(0,Math.min(A.maxx,B.maxx)-Math.max(A.minx,B.minx)); const iy=Math.max(0,Math.min(A.maxy,B.maxy)-Math.max(A.miny,B.miny)); const inter=ix*iy; const u=(A.maxx-A.minx)*(A.maxy-A.miny)+(B.maxx-B.minx)*(B.maxy-B.miny)-inter; return u<=0?0:inter/u; }

  async function aiRun(){
    if(!state.roomImg) return tip('Upload a room photo first');
    const hint=coarse(); if(hint){ state.quad=hint; syncHandles(); render(); }
    tip('Detectingâ€¦');
    try{
      const roomData=await toDataURL(state.roomImg,512);
      const payload={ messages:[{role:'user',content: $('prompt').value.trim()||'Detect the floor'}], roomImageDataURL: roomData, textureUrl:'', hintQuad: hint };
      const res=await fetch('/.netlify/functions/floor-chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const txt=await res.text(); let data={}; try{ data=JSON.parse(txt);}catch(_){}
      if(!res.ok){ throw new Error(data?.error || txt || ('HTTP '+res.status)); }
      if(Array.isArray(data.actions)){ data.actions.forEach(applyAction); }
      tip('Done');
    }catch(e){ log('AI failed: '+e.message); const h=coarse(); if(h){ state.quad=h; syncHandles(); render(); tip('Fallback used'); } }
  }

  function applyAction(action){
    const a=action?.arguments||{}; log('AI action\n'+JSON.stringify(a,null,2));
    if(Array.isArray(a.floorQuad)&&a.floorQuad.length===4){
      const hint=[...state.quad];
      const qN=normalize(a.floorQuad);
      let qImg=qN.map(imgToCanvas), qCan=qN.map(p=>({x:clamp01(p.x),y:clamp01(p.y)}));
      qImg=sortCW(qImg); qCan=sortCW(qCan);
      function score(q){ if(!q||q.length!=4) return -1; if(isBad(q)) return -0.5; return 1 + iou(q,hint); }
      const q = score(qImg)>=score(qCan) ? qImg : qCan;
      state.quad = isBad(q) ? hint : q;
      syncHandles(); render();
    }
    if(typeof a.scale==='number') state.scale=a.scale;
    if(typeof a.rotationDegrees==='number') state.rot=a.rotationDegrees;
    $('sv').textContent=state.scale.toFixed(1); $('rv').textContent=state.rot.toFixed(1)+'Â°';
  }

  function toDataURL(img,maxSide){ return new Promise(res=>{ const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height; const s=Math.min(1,(maxSide||512)/Math.max(w,h)); const c=document.createElement('canvas'); c.width=Math.round(w*s); c.height=Math.round(h*s); c.getContext('2d').drawImage(img,0,0,c.width,c.height); res(c.toDataURL('image/jpeg',0.9)); }); }

  function boot(){ const r=$('wrap').getBoundingClientRect(); room.width=r.width; room.height=r.height; out.width=r.width; out.height=r.height; drawRoom(); render(); syncHandles(); log('Boot âœ“'); }
  if(document.readyState!='loading') boot(); else window.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body></html>
